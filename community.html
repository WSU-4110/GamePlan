<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community - GamePlan</title>
    <link rel="stylesheet" href="css/styles.css">

    <style>

        .community-wrapper {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .community-title {
            text-align: center;
            margin-bottom: 25px;
            color: #fff;
            font-size: 2rem;
        }

        .comment-box textarea,
        .reply-box textarea {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            background: #1c1c1c;
            color: #fff;
            border: 1px solid #333;
            resize: vertical;
            min-height: 70px;
            font-size: 1rem;
        }

        .comment-box button,
        .reply-box button {
            margin-top: 10px;
            padding: 10px 14px;
            background: #7a4efc;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.95rem;
            transition: 0.2s;
        }

        .comment-box button:hover,
        .reply-box button:hover {
            background: #5a3ecc;
        }

        .comment {
            background: #1f1f1f;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 18px;
            color: #eaeaea;
            border: 1px solid #333;
        }

        .meta {
            font-size: .75rem;
            color: #aaa;
            margin-bottom: 10px;
        }

        .reply {
            background: #292929;
            padding: 12px;
            border-radius: 8px;
            margin-left: 25px;
            margin-top: 10px;
            border: 1px solid #333;
        }

        .reply-btn {
            background: #4a90e2;
            margin-top: 8px;
            padding: 6px 12px;
            border-radius: 6px;
        }

        .reply-btn:hover {
            background: #3578c4;
        }
    </style>
</head>

<body>
    <!-- NAVBAR FROM INDEX.HTML -->
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <div class="nav-logo">
                    <h1>GamePlan</h1>
                </div>
                <div class="nav-right">
                    <ul class="nav-menu">
                        <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
                        <li class="nav-item"><a href="browse.html" class="nav-link">Browse Code</a></li>
                        <li class="nav-item"><a href="search.html" class="nav-link">Search</a></li>
                        <li class="nav-item"><a href="community.html" class="nav-link active">Community</a></li>
                        <li class="nav-item"><a href="about.html" class="nav-link">About</a></li>
                        <li class="nav-item"><a href="login.html" class="nav-link">Login</a></li>
                    </ul>

                    <a class="nav-profile" href="profile.html">
                        <span class="profile-avatar">GP</span>
                        <span class="profile-info">
                            <span class="profile-name">Alex Mercer</span>
                            <span class="profile-role">Creator</span>
                        </span>
                    </a>

                    <div class="hamburger">
                        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <div class="community-wrapper">
            <h1 class="community-title">Community Discussion</h1>

            <!-- Post a new comment -->
            <div class="comment-box">
                <textarea id="newComment" placeholder="Write a comment..."></textarea>
                <button id="postComment">Post Comment</button>
            </div>

            <!-- Comments appear here -->
            <div id="commentSection"></div>
        </div>
    </main>

    <!-- FOOTER FROM INDEX.HTML -->
    <footer>
        <div class="container">
            <p>&copy; 2025 GamePlan</p>
        </div>
    </footer>

    <!-- Firebase Script -->
    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyCIaWxcsA9tuA98dybeeYdhXvr9-J3UXnI",
            authDomain: "community-csc4110.firebaseapp.com",
            projectId: "community-csc4110",
            storageBucket: "community-csc4110.firebasestorage.app",
            messagingSenderId: "24914636358",
            appId: "1:24914636358:web:e05a084885276481bce447",
            measurementId: "G-X7BFR48XRS"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import {
            getFirestore, collection, addDoc, serverTimestamp,
            query, orderBy, onSnapshot
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const postBtn = document.getElementById("postComment");
        const newComment = document.getElementById("newComment");
        const commentSection = document.getElementById("commentSection");

        postBtn.addEventListener("click", async () => {
            const text = newComment.value.trim();
            if (!text) return;

            await addDoc(collection(db, "comments"), {
                text,
                parentId: null,
                createdAt: serverTimestamp()
            });

            newComment.value = "";
        });

        function renderComment(docSnap, repliesMap) {
            const data = docSnap.data();
            const id = docSnap.id;

            const div = document.createElement("div");
            div.className = "comment";

            const timeText =
                data.createdAt?.toDate ? new Date(data.createdAt.toDate()).toLocaleString() : "";

            div.innerHTML = `
                <div class="meta">#${id} â€¢ ${timeText}</div>
                <p>${escape(data.text)}</p>
                <button class="reply-btn" data-id="${id}">Reply</button>

                <div id="replyContainer-${id}" style="display:none; margin-top:10px;">
                    <textarea class="reply-box" id="replyBox-${id}" placeholder="Write a reply..."></textarea>
                    <button class="post-reply" data-id="${id}">Post Reply</button>
                </div>
            `;

            const replies = repliesMap[id] || [];
            replies.forEach(r => {
                const d = document.createElement("div");
                d.className = "reply";
                const rTime = r.createdAt?.toDate ? new Date(r.createdAt.toDate()).toLocaleString() : "";
                d.innerHTML = `<div class="meta">${rTime}</div><p>${escape(r.text)}</p>`;
                div.appendChild(d);
            });

            return div;
        }

        function escape(str) {
            return str?.replace(/[&<>"']/g, m =>
                ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m])
            );
        }

        const q = query(collection(db, "comments"), orderBy("createdAt", "asc"));
        onSnapshot(q, (snapshot) => {
            const allDocs = [];
            snapshot.forEach(doc => allDocs.push({ id: doc.id, doc }));

            const repliesMap = {};
            const topLevel = [];

            allDocs.forEach(item => {
                const data = item.doc.data();
                if (data.parentId) {
                    repliesMap[data.parentId] ??= [];
                    repliesMap[data.parentId].push({ id: item.id, ...data });
                } else {
                    topLevel.push(item.doc);
                }
            });

            commentSection.innerHTML = "";

            topLevel.forEach(doc => {
                const c = renderComment(doc, repliesMap);
                commentSection.appendChild(c);
            });

            document.querySelectorAll(".reply-btn").forEach(btn => {
                btn.onclick = () => {
                    const id = btn.dataset.id;
                    const box = document.getElementById(`replyContainer-${id}`);
                    box.style.display = box.style.display === "none" ? "block" : "none";
                };
            });

            document.querySelectorAll(".post-reply").forEach(btn => {
                btn.onclick = async () => {
                    const id = btn.dataset.id;
                    const box = document.getElementById(`replyBox-${id}`);
                    const text = box.value.trim();

                    if (!text) return;

                    await addDoc(collection(db, "comments"), {
                        text,
                        parentId: id,
                        createdAt: serverTimestamp()
                    });

                    box.value = "";
                };
            });
        });
    </script>

</body>
</html>
